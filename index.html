<!DOCTYPE html>
<html ng-app="app" tabindex="-1">
  <head>  
    <script src="bower_components/platform/platform.js"></script>
    <script src="bower_components/japi/mocks/mockJapi.js" type="text/javascript"></script>
    <script src="bower_components/japi/js/japi.js" type="text/javascript"></script>
    <script src="bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>

    <!--
    <script src="js/angular.js" type="text/javascript"></script>
    <script src="js/angular-route.js" type="text/javascript"></script>
    <script src="js/app.js" type="text/javascript"></script>
    -->
    
    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/font-roboto/roboto.html">
    <link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
    <link rel="import" href="bower_components/core-menu/core-menu.html">
    <link rel="import" href="bower_components/core-item/core-item.html">
    <link rel="import" href="bower_components/paper-fab/paper-fab.html" >
    <link rel="import" href="sopro_components/core-scaffold/core-scaffold.html">
    <link rel="import" href="sopro_components/group-manager/group-card-titlebar.html">
    <link rel="import" href="sopro_components/group-manager/group-card.html">
    <link rel="import" href="sopro_components/group-manager/card-tray.html">
    <link rel="import" href="sopro_components/sopro-icon-button/sopro-icon-button.html">

    <link rel="stylesheet" type="text/css" href="assets/plugins/font-awesome-4.1.0/css/font-awesome.css">
    <link rel="stylesheet" type="text/css" href="css/custom.css">
  </head>
  <body unresolved ng-controller="appCtrl" tabindex="-1">
    <div id="applicationContainer">
      <core-scaffold id="groupScaffold" narrow="true">
        <core-header-panel navigation flex mode="seamed">
          <core-toolbar hidden></core-toolbar>
          <core-menu theme="core-light-theme">
            <core-item icon="settings" label="item1"></core-item>
            <core-item icon="settings" label="item2"></core-item>
          </core-menu>
        </core-header-panel>
        <div class="mainTitle" tool>
            Groups and Governance
        </div>
        <div id="listMorphButtons" tool horizontal layout>
          <sopro-icon-button 
          id="viewStreamButton" 
          tabindex="0"
          icon="view-stream"></sopro-icon-button>
          <sopro-icon-button 
          id="viewQuiltButton" 
          tabindex="0"
          icon="view-quilt"></sopro-icon-button>
        </div>
        <div layout vertical center relative>
          <group-card-titlebar id="newCardTitlebar"></group-card-titlebar>
          <card-tray id="cards" pattern="stream" tabindex="-1">
            <template id="cardsTemplate" is="auto-binding" repeat="{{groups}}">
              <group-card cardtitle="{{name}}"></group-card>
            </template>
            <!--
            <group-card title="Voodoo" type="Broadcast" number="48"></group-card>
            <group-card title="Hiro" type="Cult" number="666"></group-card>
            <group-card title="Plato" type="Anonymous" number="+9000"></group-card>
            <group-card title="Jon" type="Broadcast" number="77"></group-card>
            <group-card title="Raf" type="Broadcast" number="0"></group-card>
            -->
          </card-tray>
        </div>
        <!--
        <template id="inputsTemplate" is="auto-binding" repeat="{{groups}}">
          <input value="{{name}}"></input>
        </template>
        -->
        <paper-fab 
          id="addGroupCardButton" 
          icon="add"
          title="Add New Group"
          role="button"
          tabindex="0"
        ></paper-fab>
      </core-scaffold>
    </div>
  </body>
  <script>
    var Cambrian = Cambrian || {};
    var japi;
    if(Cambrian.JAPI !== undefined && !Cambrian.isMockCambrian){
      console.log('Instantiating japi');
      japi = Cambrian.JAPI();
    } else {
      // use mocks
      console.log('Instantiating mock japi');
      japi = Cambrian.mockJAPI();
    }

    document.addEventListener('polymer-ready', function () {
      console.log('polymer-ready');

      // Bind data to templates:
      var t1 = document.getElementById('cardsTemplate');
      t1.groups = japi.me.groups;
      //var t2 = document.getElementById('inputsTemplate');
      //t2.groups = japi.me.groups;

      // Close the drawer that's open by default:
      document.getElementById('groupScaffold').closeDrawer();

      // Set up fab to fire group-card-create event when clicked:
      var fab = document.getElementById('addGroupCardButton');
      fab.onclick = function(){
        var fireEvent = 
          new CustomEvent('group-card-create', {
            bubbles: true,
            detail:{ "cardtitle": "" } 
          });
        this.dispatchEvent(fireEvent);
      };
      
      fab.onkeypress = function(e){
        if(e.which == 13 || e.which == 32){
          fab.click();
        };
      };


      var stream = document.getElementById('viewStreamButton');
      stream.onclick = function(){
        console.log('Firing card-tray-pattern-change');
        var fireEvent = 
          new CustomEvent('card-tray-pattern-change', {
            bubbles: true,
            detail:{ "pattern": "stream" } 
          });
        console.log(fireEvent);
        document.dispatchEvent(fireEvent);
      };

      var quilt = document.getElementById('viewQuiltButton');
      quilt.onclick = function(){
        console.log('Firing card-tray-pattern-change');
        var fireEvent = 
          new CustomEvent('card-tray-pattern-change', {
            bubbles: true,
            detail:{ "pattern": "quilt" } 
          });
        document.dispatchEvent(fireEvent);
      };

    });
      
    //Actually instantiate a group-card on group-card-create: 
    document.addEventListener('group-card-create', function (event) {
      var newCardEl;
      console.log("core-scaffold heard event group-card-create from some other element");
      //console.log(event);
      var newCard = document.createElement("group-card");
      newCard.cardtitle = event.detail.cardtitle;
      newCardEl = document.getElementById('cards').appendChild(newCard);

      // Clicking the element immediately seems to fail in firefox, this delay
      // helps?
      window.setTimeout(function(){
        newCardEl.click();
      }, 200)
    });

    /*
    Useful to see what is going on while debugging changing focus with the tab
    key:
    */
    window.setInterval(function(){
      console.log(document.activeElement);
    }, 5000);

  </script>
</html>
