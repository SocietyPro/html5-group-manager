<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../sopro-icon-button/sopro-icon-button.html">
<link rel="import" href="../sopro-card/sopro-card.html">

<polymer-element 
name="group-card" 
attributes="cardtitle type number editing z"
extends="sopro-card"
tabindex="-1"
on-focus="{{onFocuses}}"
on-blur="{{onBlurs}}"
>
  <template >
    <shadow></shadow>
    <style>
      :host {
      }
      :host[editing="true"] {
      }

      :host h2{
        display: block;
        margin: 0;
        font-size: 1.2rem;
        line-height: 41px;
      }

      :host[editing="true"] h2{
        display: none;
      }



      :host titlebar-input{
        display: none;
      }
      :host[editing="true"] titlebar-input{
        font-size: 1.2rem;
        display: block;
      }

      :host .groupDetails {
        display: inline !important;
      }

      #card{
        padding: 0 24px;
        min-height: 64px;
      }

    </style>
    <div id="tabCatcher1" tabindex="0"></div>
    <div 
    on-focus="{{onFocuses}}"
    on-blur="{{onBlurs}}"
    id="card" 
    layout vertical
    tabindex="-1"
    >
      <div layout horizontal>
        <h2 flex>{{cardtitle}}</h2>
        <titlebar-input 
        flex 
        id="cardTitle"
        inputValue="{{cardtitle}}"
        on-focus="{{onFocuses}}"
        on-blur="{{onBlurs}}"
        tabindex="-1"
        ></titlebar-input>
        <sopro-icon-button 
        id="saveCard"
        icon="save" 
        self-center
        hidden?="{{editing==='false'}}"
        on-focus="{{onFocuses}}"
        on-blur="{{onBlurs}}"
        tabindex="0"
        ></sopro-icon-button>
      </div>
      <div class="groupDetails" layout horizontal>
        <span>{{type}}</span>
        <span>
          <i class="fa fa-users"></i>
          {{number}}
        </span>
      </div>
    </div>
    <div id="tabCatcher2" tabindex="0"></div>
    <paper-shadow z="{{z}}" animated="true"></paper-shadow>
  </template>

  <script>
    Polymer('group-card', {
      publish: { // If you want to expose properties as tag attributes
        cardtitle: {value: '', reflect: true},
        type: '',
        number: '',
        editing: {value: "false", reflect: true},
        z: {value: "1", reflect: true},
        groupMembers: [],
      },
      setZ: function(){
        /* Cases:
        unfocused, not editing: 1
        unfocused, editing: 2
        focused, not editing: 2
        card focused, editing: 2
        input focused, editing: 3
        */

        //console.log(document.activeElement); //console.log(this.$.card);

        var z = 1;
        if(
           (this.impl        === document.activeElement)
        || (this.$.card.impl === document.activeElement)
        ) { // Card itself focused
          if(this.editing == "false"){
            z += 1; // Bump a focused but not-edited card up
          } else {
            // Don't bump a focused and edited card here. we add 1 for editing below
          }
        } else if(
           (this.$.cardTitle.impl === document.activeElement)
        || (this.$.cardTitle.impl.querySelector('#input')  === document.activeElement)
        || (this.$.saveCard.impl  === document.activeElement)
        ) { 
          // Input or button inside card have focus
          z += 1;
        };

        if(this.editing === "true"){ // The card is opened for editing
          z += 1;
        };

        this.z = z;
      },
      onCardClicked: function(e){
        // The default action of clicking the card is to start editing it. 
        // We have to identify whether the click was on the save button or the
        // input field. In those cases, we ignore the click. (The save button
        // triggers stopEditing on its own.)

        //console.log('onCardClicked');
        //console.log(e);

        // Get the currently focused element
        try{ var aId = document.activeElement.id;
        } catch (e){ var aId = null; };
        try{ var eId = e.srcElement.id || e.explicitOriginalTarget.id
        } catch (e){ var eId = null; };
        console.log(aId, eId);
        /* Pressing enter on children elements should not click the card. */
        if(eId == "saveCard"
        || aId == "saveCard"
        || aId == "input"
        || aId == "cardTitle"){
          //console.log('Not triggering click on group-card from child element click')
          return;
        } else {
          this.startEditing();
        };
      },
      onBlurs: function(e){
        //this.stopEditing();
        /*
        if(this.editing == "true"){
          this.z = "1";
        } else {
          this.z = "0";
        };
        */
        this.setZ();
        this.$.tabCatcher1.setAttribute("tabindex", "0");
        this.$.tabCatcher2.setAttribute("tabindex", "0");
      },
      onFocuses: function(e){
        //console.log('onFocuses');
        this.$.tabCatcher1.setAttribute("tabindex", "-1");
        this.$.tabCatcher2.setAttribute("tabindex", "-1");
        this.setZ();
        /*
        if(this.editing == "true"){
          this.z = "2";
        } else {
          this.z = "1";
        };
        */
      },
      startEditing: function(){
        console.log('startEditing');
        this.editing = "true";
        //this.z = "2";
        this.setZ();
        this.$.cardTitle.focus();
        this.$.tabCatcher1.setAttribute("tabindex", "-1");
        this.$.tabCatcher2.setAttribute("tabindex", "-1");
      },
      stopEditing: function(){
        console.log('stopEditing');
        this.editing = "false";
        //this.z = "1";
        this.setZ();
        this.$.card.focus();
      },
      attached: function(){
        // Store a reference to the group-card element for use in callbacks:
        var that = this;

        // Make clicks on the button stop propagating:
        this.$.saveCard.addEventListener('click', function(e){
          that.stopEditing();
          e.stopPropagation();
        });
        // Pass clicks on the group-card to its click handler:
        this.addEventListener('click', this.onCardClicked, true);
        //this.addEventListener('tap', this.onCardClicked, true);

        // Bind keys on group card:
        this.addEventListener('keydown', function(e){
          //console.log(e);
          // Do nothing with keypresses on save button; they have their own handler
          try{ var eId = e.srcElement.id || e.explicitOriginalTarget.id
          } catch (e){ var eId = null; };
          if( eId === 'saveCard' ){
            return;
          };

          // Figure out what has focus when the key was pressed:
          try{
            var aId = document.activeElement.id;
            }catch(e){
            var aId = "";
          };

          // Bind Enter, Space, Escape keys appropriately:
          if(e.which === 13){ // Enter
            if(aId === 'cardTitle' || aId === 'input'){
              that.stopEditing();
              return; // Enter on title field means commit
            };
            that.startEditing(); // Enter on card itself means edit
          };
          
          if(e.which === 32){
            if(aId === 'cardTitle' || aId === 'input'){
              return; // Space on title field is meaningless
            };
            that.startEditing(); // Space on card itself means edit
          };

          // Firefox doesn't let you use e.which for Escape:
          var code = e.keyCode ? e.keyCode : e.which;
          if(code === 27){ // Escape
            // Check if we hit Escape with a card selected. If so, focus the add new group element
            var ae = document.activeElement;
            if((ae.tagName.toUpperCase() == "GROUP-CARD")
            || (aId === 'card')
            ){
              that.stopEditing();
              // Put the focus in the input element within newCardTitlebar:
              document.getElementById("newCardTitlebar").$.titleInput.focus();
              return; 
            } else { // Something else was selected. Stop editing (which focuses the card itself)
              that.stopEditing();
            }
          };

          if(code === 40){ // Down
            e.preventDefault();
            var sib = that.nextElementSibling;
            if(sib !== null) { 
              sib.focus();
            } else { // Wrap to top
              // Skip hidden template element at children[0]:
              that.parentElement.children[1].focus();
            }
          };

          if(code === 38){ // Up
            e.preventDefault();
            var sib = that.previousElementSibling;
            // Our card-tray has a hidden template element before children group-cards
            if(sib.tagName.toUpperCase()==="TEMPLATE"){ sib = null; };

            if(sib !== null) { 
              sib.focus();
            } else { // Wrap to bottom
              that.parentElement.lastElementChild.focus(); 
            }
          };

        }, true);


        // There are a pair of tabCatcher divs around #card.

        // When #card, #cardTitle, or #cardSave gets focus, 
        // we set tabCatchers[tabindex='-1']. This way, tabbing away
        // from #card never goes to its own tabCatchers.

        // When the card elements lose focus, we set tabCatchers[tabindex='0'].
        // So, from outside a card, you can tab onto its tab catchers. When you
        // do, the below listeners redirect the focus onto #card, (which then
        // disables the tab catchers again.)

        // See .onBlurs and .onFocuses.
        this.$.tabCatcher1.addEventListener('focus',function(){
          that.$.card.focus();
        })
        this.$.tabCatcher2.addEventListener('focus',function(){
          that.$.card.focus();
        })
      },
    });
  </script>
</polymer-element>
