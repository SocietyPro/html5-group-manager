<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../sopro-icon-button/sopro-icon-button.html">
<link rel="import" href="../sopro-card/sopro-card.html">

<polymer-element 
name="group-card" 
attributes="title editing z"
extends="sopro-card"
>
  <template >
    <shadow></shadow>
    <style>
      :host {
      }
      :host[editing="true"] {
      }

      :host h2{
        display: block;
        margin: 0;
        font-size: 1.2rem;
        line-height: 41px;
      }
      :host[editing="true"] h2{
        display: none;
      }

      :host titlebar-input{
        display: none;
      }
      :host[editing="true"] titlebar-input{
        font-size: 1.2rem;
        display: block;
      }

      #card{
        padding: 20px;
      }

    </style>
    <div id="tabCatcher1" tabindex="0"></div>
    <div 
    on-focus="{{onFocuses}}"
    on-blur="{{onBlurs}}"
    id="card" 
    layout vertical
    tabindex="0"
    >
      <div layout horizontal>
        <h2 flex>{{title}}</h2>
        <titlebar-input 
        flex 
        id="cardTitle"
        inputValue="{{title}}"
        on-focus="{{onFocuses}}"
        on-blur="{{onBlurs}}"
        tabindex="-1"
        ></titlebar-input>
        <sopro-icon-button 
        id="saveCard"
        icon="save" 
        self-center
        hidden?="{{editing==='false'}}"
        on-focus="{{onFocuses}}"
        on-blur="{{onBlurs}}"
        <!-- Binding this manually on-click="{{stopEditing}}" -->
        tabindex="0"
        ></sopro-icon-button>
      </div>
      <div flex>
        <content></content>
      </div>
    </div>
    <div id="tabCatcher2" tabindex="0"></div>
    <paper-shadow z="{{z}}" animated="true"></paper-shadow>
  </template>

  <script>
    Polymer('group-card', {
      publish: { // If you want to expose properties as tag attributes
        title: '',
        editing: {value: "false", reflect: true},
        z: {value: "0", reflect: true},
        groupMembers: [],
      },
      onCardClicked: function(e){
        // The default action of clicking the card is to start editing it. 
        // We have to identify whether the click was on the save button or the
        // input field. In those cases, we ignore the click. (The save button
        // triggers stopEditing on its own.)

        //console.log('onCardClicked');
        //console.log(e);

        // Get the currently focused element
        try{ var aId = document.activeElement.id;
        } catch (e){ var aId = null; };
        try{ var eId = e.explicitOriginalTarget.id
        } catch (e){ var eId = null; };
        console.log(aId, eId);
        /* Pressing enter on children elements should not click the card. */
        if(eId == "saveCard"
        || aId == "saveCard"
        || aId == "input"
        || aId == "cardTitle"){
          //console.log('Not triggering click on group-card from child element click')
          return;
        } else {
          this.startEditing();
        };
      },
      onBlurs: function(e){
        //this.stopEditing();
        if(this.editing == "true"){
          this.z = "1";
        } else {
          this.z = "0";
        };
        this.$.tabCatcher1.setAttribute("tabindex", "0");
        this.$.tabCatcher2.setAttribute("tabindex", "0");
      },
      onFocuses: function(e){
        //console.log('onFocuses');
        this.$.tabCatcher1.setAttribute("tabindex", "-1");
        this.$.tabCatcher2.setAttribute("tabindex", "-1");
        if(this.editing == "true"){
          this.z = "2";
        } else {
          this.z = "1";
        };
      },
      startEditing: function(){
        console.log('startEditing');
        this.editing = "true";
        this.z = "2";
        this.$.cardTitle.focus();
        this.$.tabCatcher1.setAttribute("tabindex", "-1");
        this.$.tabCatcher2.setAttribute("tabindex", "-1");
      },
      stopEditing: function(){
        console.log('stopEditing');
        this.editing = "false";
        this.z = "1";
        this.$.card.focus();
      },
      attached: function(){
        // Store a reference to the group-card element for use in callbacks:
        var that = this;

        // Make clicks on the button stop propagating:
        this.$.saveCard.addEventListener('click', function(e){
          that.stopEditing();
          e.stopPropagation();
        });
        // Pass clicks on the group-card to its click handler:
        this.addEventListener('click', this.onCardClicked, true);
        //this.addEventListener('tap', this.onCardClicked, true);

        // Bind keys on group card:
        this.addEventListener('keypress', function(e){
          //console.log(e);
          // Do nothing with keypresses on save button; they have their own handler
          try{ var eId = e.explicitOriginalTarget.id
          } catch (e){ var eId = null; };
          if( eId === 'saveCard' ){
            return;
          };

          // Figure out what has focus when the key was pressed:
          try{
            var aId = document.activeElement.id;
            }catch(e){
            var aId = "";
          };

          // Bind Enter, Space, Escape keys appropriately:
          if(e.which === 13){ // Enter
            if(aId === 'cardTitle' || aId === 'input'){
              that.stopEditing();
              return; // Enter on title field means commit
            };
            that.startEditing(); // Enter on card itself means edit
          };
          
          if(e.which === 32){
            if(aId === 'cardTitle' || aId === 'input'){
              return; // Space on title field is meaningless
            };
            that.startEditing(); // Space on card itself means edit
          };

          // Firefox doesn't let you use e.which for Escape:
          var code = e.keyCode ? e.keyCode : e.which;
          if(code === 27){ // Escape
            that.stopEditing();
          };

        }, true);


        // There are a pair of tabCatcher divs around #card.

        // When #card, #cardTitle, or #cardSave gets focus, 
        // we set tabCatchers[tabindex='-1']. This way, tabbing away
        // from #card never goes to its own tabCatchers.

        // When the card elements lose focus, we set tabCatchers[tabindex='0'].
        // So, from outside a card, you can tab onto its tab catchers. When you
        // do, the below listeners redirect the focus onto #card, (which then
        // disables the tab catchers again.)

        // See .onBlurs and .onFocuses.
        this.$.tabCatcher1.addEventListener('focus',function(){
          that.$.card.focus();
        })
        this.$.tabCatcher2.addEventListener('focus',function(){
          that.$.card.focus();
        })
      },
    });
  </script>
</polymer-element>
